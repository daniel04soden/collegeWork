# proxy-addr

[\[\[<https://badgen.net/npm/v/proxy-addr>](https://npmjs.org/package/proxy-addr)\]\]
[\[\[<https://badgen.net/npm/dm/proxy-addr>](https://npmjs.org/package/proxy-addr)\]\]
[\[\[<https://badgen.net/npm/node/proxy-addr>](https://nodejs.org/en/download)\]\]
[\[\[<https://badgen.net/github/checks/jshttp/proxy-addr/master?label=ci>](https://github.com/jshttp/proxy-addr/actions?query=workflow%3Aci)\]\]
[\[\[<https://badgen.net/coveralls/c/github/jshttp/proxy-addr/master>](https://coveralls.io/r/jshttp/proxy-addr?branch=master)\]\]

Determine address of proxied request

## Install

This is a [Node.js](https://nodejs.org/en/) module available through the
[npm registry](https://www.npmjs.com/). Installation is done using the
[`npm install`{.verbatim}
command](https://docs.npmjs.com/getting-started/installing-npm-packages-locally):

``` {.bash org-language="sh"}
$ npm install proxy-addr
```

## API

``` {.javascript org-language="js"}
var proxyaddr = require('proxy-addr')
```

### proxyaddr(req, trust)

Return the address of the request, using the given `trust`{.verbatim}
parameter.

The `trust`{.verbatim} argument is a function that returns
`true`{.verbatim} if you trust the address, `false`{.verbatim} if you
don\'t. The closest untrusted address is returned.

``` {.javascript org-language="js"}
proxyaddr(req, function (addr) { return addr === '127.0.0.1' })
proxyaddr(req, function (addr, i) { return i < 1 })
```

The `trust`{.verbatim} arugment may also be a single IP address string
or an array of trusted addresses, as plain IP addresses, CIDR-formatted
strings, or IP/netmask strings.

``` {.javascript org-language="js"}
proxyaddr(req, '127.0.0.1')
proxyaddr(req, ['127.0.0.0/8', '10.0.0.0/8'])
proxyaddr(req, ['127.0.0.0/255.0.0.0', '192.168.0.0/255.255.0.0'])
```

This module also supports IPv6. Your IPv6 addresses will be normalized
automatically (i.e. =fe80::00ed:1= equals
`fe80:0:0:0:0:0:ed:1`{.verbatim}).

``` {.javascript org-language="js"}
proxyaddr(req, '::1')
proxyaddr(req, ['::1/128', 'fe80::/10'])
```

This module will automatically work with IPv4-mapped IPv6 addresses as
well to support node.js in IPv6-only mode. This means that you do not
have to specify both `::ffff:a00:1`{.verbatim} and
`10.0.0.1`{.verbatim}.

As a convenience, this module also takes certain pre-defined names in
addition to IP addresses, which expand into IP addresses:

``` {.javascript org-language="js"}
proxyaddr(req, 'loopback')
proxyaddr(req, ['loopback', 'fc00:ac:1ab5:fff::1/64'])
```

- `loopback`{.verbatim}: IPv4 and IPv6 loopback addresses (like
  `::1`{.verbatim} and `127.0.0.1`{.verbatim}).
- `linklocal`{.verbatim}: IPv4 and IPv6 link-local addresses (like
  `fe80::1:1:1:1`{.verbatim} and `169.254.0.1`{.verbatim}).
- `uniquelocal`{.verbatim}: IPv4 private addresses and IPv6 unique-local
  addresses (like `fc00:ac:1ab5:fff::1`{.verbatim} and
  `192.168.0.1`{.verbatim}).

When `trust`{.verbatim} is specified as a function, it will be called
for each address to determine if it is a trusted address. The function
is given two arguments: `addr`{.verbatim} and `i`{.verbatim}, where
`addr`{.verbatim} is a string of the address to check and `i`{.verbatim}
is a number that represents the distance from the socket address.

### proxyaddr.all(req, \[trust\])

Return all the addresses of the request, optionally stopping at the
first untrusted. This array is ordered from closest to furthest
(i.e. =arr\[0\] `=`{.verbatim} req.connection.remoteAddress=).

``` {.javascript org-language="js"}
proxyaddr.all(req)
```

The optional `trust`{.verbatim} argument takes the same arguments as
`trust`{.verbatim} does in `proxyaddr(req, trust)`{.verbatim}.

``` {.javascript org-language="js"}
proxyaddr.all(req, 'loopback')
```

### proxyaddr.compile(val)

Compiles argument `val`{.verbatim} into a `trust`{.verbatim} function.
This function takes the same arguments as `trust`{.verbatim} does in
`proxyaddr(req, trust)`{.verbatim} and returns a function suitable for
`proxyaddr(req, trust)`{.verbatim}.

``` {.javascript org-language="js"}
var trust = proxyaddr.compile('loopback')
var addr = proxyaddr(req, trust)
```

This function is meant to be optimized for use against every request. It
is recommend to compile a trust function up-front for the trusted
configuration and pass that to `proxyaddr(req, trust)`{.verbatim} for
each request.

## Testing

``` {.bash org-language="sh"}
$ npm test
```

## Benchmarks

``` {.bash org-language="sh"}
$ npm run-script bench
```

## License

[MIT](LICENSE)
